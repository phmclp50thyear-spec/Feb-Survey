<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PHMC | New Survey</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        .collapsible-content { max-height: 0; overflow: hidden; transition: all 0.5s cubic-bezier(0, 1, 0, 1); }
        .collapsible-content.open { max-height: 2000px; transition: all 0.5s cubic-bezier(1, 0, 1, 0); }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans">

    <script>
        const SB_URL = 'https://osfwbhcqibhtobaoojrv.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9zZndiaGNxaWJodG9iYW9vanJ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMDU3MzksImV4cCI6MjA4NTY4MTczOX0.2NNaOhHfXMsYVWrBkJ1gudU4l0in35WU4bT4UgzkvlA';
        const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

        async function init() {
            const { data: { user } } = await supabaseClient.auth.getUser();
            if (!user) window.location.href = 'index.html';
            document.getElementById('userDisplay').innerText = user.email;
            loadDepts();
        }
        init();
    </script>

    <nav class="bg-white border-b p-4 mb-8 shadow-sm">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-8">
                <h1 class="font-black text-indigo-600 tracking-tighter text-xl uppercase">PHMC Portal</h1>
                <div class="hidden md:flex items-center gap-6">
                    <a href="survey.html" class="text-sm font-bold text-indigo-600 flex items-center gap-2">
                        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line></svg>
                        New Survey
                    </a>
                    <a href="reports.html" class="text-sm font-bold text-gray-400 hover:text-indigo-600 transition flex items-center gap-2">
                        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
                        Analytics
                    </a>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <span id="userDisplay" class="hidden md:inline text-xs font-medium text-gray-400 italic">...</span>
                <button onclick="supabaseClient.auth.signOut().then(() => window.location.href='index.html')" class="bg-red-50 text-red-600 px-4 py-2 rounded-lg text-sm font-bold hover:bg-red-100 transition">Logout</button>
            </div>
        </div>
    </nav>

    <div class="max-w-4xl mx-auto p-4">
        <button id="toggleForm" class="bg-indigo-600 text-white p-4 rounded-full shadow-xl hover:rotate-90 transition-all mb-8">
            <svg width="28" height="28" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
        </button>

        <form id="surveyForm" class="collapsible-content bg-white rounded-2xl shadow-xl border border-gray-100">
            <div class="p-6 md:p-10 space-y-8">
                <h2 class="text-2xl font-bold text-gray-800 border-b pb-4">New Patient Entry</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <input type="number" name="age" placeholder="Age" required class="p-3 bg-gray-50 border rounded-xl outline-none focus:ring-2 focus:ring-indigo-500">
                    <select name="gender" required class="p-3 bg-gray-50 border rounded-xl outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="">Gender...</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                    </select>
                    <input type="text" name="location" placeholder="Location" required class="p-3 bg-gray-50 border rounded-xl outline-none focus:ring-2 focus:ring-indigo-500">
                    <input type="text" name="occupation" placeholder="Occupation" required class="p-3 bg-gray-50 border rounded-xl outline-none focus:ring-2 focus:ring-indigo-500">
                </div>

                <div class="bg-slate-50 p-4 rounded-xl flex gap-6">
                    <label class="flex items-center gap-2"><input type="radio" name="patient_type" value="New" required> New Patient</label>
                    <label class="flex items-center gap-2"><input type="radio" name="patient_type" value="Repeat"> Repeat Patient</label>
                </div>

                <select id="departmentDropdown" name="primary_objective" required class="w-full p-3 bg-gray-50 border rounded-xl outline-none"></select>

                <div class="pt-6 border-t">
                    <p class="font-bold mb-4">Patient Experience:</p>
                    <div class="flex gap-4">
                        <label class="flex-1 p-4 border rounded-xl text-center cursor-pointer has-[:checked]:bg-green-100"><input type="radio" name="experience" value="Positive" required class="hidden" onclick="document.getElementById('reasonsBox').classList.remove('hidden')">Positive</label>
                        <label class="flex-1 p-4 border rounded-xl text-center cursor-pointer has-[:checked]:bg-red-100"><input type="radio" name="experience" value="Negative" class="hidden" onclick="document.getElementById('reasonsBox').classList.remove('hidden')">Negative</label>
                    </div>
                    <div id="reasonsBox" class="hidden mt-4">
                        <textarea name="feedback_details" placeholder="Detailed feedback..." rows="3" class="w-full p-4 bg-gray-50 border rounded-xl outline-none"></textarea>
                    </div>
                </div>

                <button type="submit" id="submitBtn" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-indigo-700 transition">Save Survey Results</button>
            </div>
        </form>
    </div>

    <script>
        const form = document.getElementById('surveyForm');
        document.getElementById('toggleForm').onclick = () => form.classList.toggle('open');

        async function loadDepts() {
            const { data } = await supabaseClient.from('hospital_departments').select('name').eq('is_active', true);
            document.getElementById('departmentDropdown').innerHTML = '<option value="">Select Department</option>' + data.map(d => `<option value="${d.name}">${d.name}</option>`).join('');
        }

        form.onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.innerText = 'Saving...'; btn.disabled = true;
            
            const fd = new FormData(form);
            const { error } = await supabaseClient.from('survey_submissions').insert([{
                age: parseInt(fd.get('age')),
                gender: fd.get('gender'),
                location: fd.get('location'),
                occupation: fd.get('occupation'),
                patient_type: fd.get('patient_type'),
                primary_objective: fd.get('primary_objective'),
                experience_rating: fd.get('experience'),
                feedback_details: fd.get('feedback_details')
            }]);

            if (error) alert(error.message);
            else { alert('Saved!'); form.reset(); form.classList.remove('open'); }
            btn.innerText = 'Save Survey Results'; btn.disabled = false;
        };
    </script>
</body>
</html>
